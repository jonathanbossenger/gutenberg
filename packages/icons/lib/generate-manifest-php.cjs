/**
 * External dependencies
 */
const path = require( 'path' );
const { readFile, writeFile } = require( 'fs' ).promises;

const MANIFEST_JSON_PATH = path.join( __dirname, '..', 'src', 'manifest.json' );
const MANIFEST_PHP_PATH = path.join( __dirname, '..', 'src', 'manifest.php' );

/**
 * Escapes single quotes in PHP strings.
 *
 * @param {string} str String to escape.
 * @return {string} Escaped string.
 */
function escapePHPString( str ) {
	return str.replace( /'/g, "\\'" );
}

/**
 * Formats a PHP array key with proper indentation and alignment.
 *
 * @param {string} key          Array key.
 * @param {number} maxKeyLength Maximum key length for alignment.
 * @return {string} Formatted key.
 */
function formatPHPKey( key, maxKeyLength ) {
	const padding = ' '.repeat( maxKeyLength - key.length );
	return `\t'${ escapePHPString( key ) }'${ padding }`;
}

/**
 * Generates PHP array from JSON manifest.
 *
 * @param {Array} manifest JSON manifest array.
 * @return {string} PHP code.
 */
function generatePHPArray( manifest ) {
	// Find the maximum key length for alignment
	const maxKeyLength = Math.max(
		...manifest.map( ( item ) => item.slug.length )
	);

	const phpEntries = manifest.map( ( item ) => {
		const key = formatPHPKey( item.slug, maxKeyLength );
		const label = escapePHPString( item.label );
		const filePath = escapePHPString( item.filePath );

		return `${ key } => array(
		'label'    => _x( '${ label }', 'icon label', 'gutenberg' ),
		'filePath' => '${ filePath }',
	),`;
	} );

	return `return array(
${ phpEntries.join( '\n' ) }
);`;
}

/**
 * Generates manifest.php from manifest.json.
 * Only includes icons with public: true.
 */
async function generateManifestPHP() {
	const manifestJson = await readFile( MANIFEST_JSON_PATH, 'utf8' );
	const manifest = JSON.parse( manifestJson );
	const publicIcons = manifest.filter( ( item ) => item.public === true );
	const phpHeader = `<?php
// This file is automatically generated. Do not edit directly.
if ( ! defined( 'ABSPATH' ) ) {
	die( 'Silence is golden.' );
}

`;
	const phpArray = generatePHPArray( publicIcons );
	const phpContent = phpHeader + phpArray + '\n';
	await writeFile( MANIFEST_PHP_PATH, phpContent, 'utf8' );
}

if ( module === require.main ) {
	generateManifestPHP();
}
