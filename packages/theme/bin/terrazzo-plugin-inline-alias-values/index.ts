/**
 * External dependencies
 */
import { type Plugin } from '@terrazzo/parser';

interface InlineAliasValuesOptions {
	/**
	 * Output filename for the generated aliased tokens mapping.
	 */
	filename?: string;

	/**
	 * Pattern matching IDs of tokens whose values should be inlined into their alias references.
	 */
	pattern: RegExp;

	/**
	 * Optional function to transform token IDs in the output.
	 */
	tokenId?: ( tokenId: string ) => string;
}

/**
 * Inlines the values of tokens matching the given pattern into their alias
 * references. Matching tokens are removed from the output, and a TypeScript
 * file is emitted with the mapping of aliased tokens.
 *
 * @param options          The options for the plugin.
 * @param options.filename
 * @param options.pattern
 * @param options.tokenId
 */
export default function inlineAliasValues( {
	filename,
	pattern,
	tokenId = ( id ) => id,
}: InlineAliasValuesOptions ): Plugin {
	const aliasedBy: Record< string, string[] > = {};

	return {
		name: '@wordpress/terrazzo-plugin-inline-alias-values',
		async transform( { tokens } ) {
			Object.keys( tokens )
				.filter( ( id ) => pattern.test( id ) )
				.forEach( ( id ) => {
					const token = tokens[ id ];
					if ( token.aliasedBy ) {
						aliasedBy[ tokenId( id ) ] =
							token.aliasedBy.map( tokenId );

						for ( const aliasedId of token.aliasedBy ) {
							Object.assign( tokens[ aliasedId ], {
								$value: token.$value,
								mode: token.mode,
								originalValue: token.originalValue,
							} );
						}
					}

					delete tokens[ id ];
				} );
		},
		async build( { outputFile } ) {
			if ( ! filename ) {
				return;
			}

			const json = JSON.stringify( aliasedBy, null, 2 );

			outputFile(
				filename,
				[
					'/**',
					' * This file is generated by the @wordpress/terrazzo-plugin-inline-alias-values plugin.',
					' * Do not edit this file directly.',
					' */',
					'',
					`export default ${ json } as Record< string, string[] >;`,
					'',
				].join( '\n' )
			);
		},
	};
}
